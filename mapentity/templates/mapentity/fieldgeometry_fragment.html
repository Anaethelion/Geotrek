{% load leaflet_tags geojson_tags static mapentity %}

{% leaflet_map module fitextent=False %}
<style type="text/css">
    {% if not display_wkt %}#{{ attrs.id }} { display: none; }{% endif %}
</style>

{% block requirements %}
    <script type="text/javascript" src="{% static "core/formfield.js" %}"></script>
{% endblock requirements %}

{% if display_wkt %}<p> Geom debugging window:</p>{% endif %}
{% include "floppyforms/textarea.html" %}

<script type="text/javascript">
if (! {{ module }}); var {{ module }} = {};

{% block settings %}
var {{ module }}_settings = {
    'enableDrawing': {
        'is_polygon': {{ is_polygone|yesno:"true,false" }},
        'is_marker': {{ is_point|yesno:"true,false" }},
        'is_polyline': {{ is_linestring|yesno:"true,false" }}
    },
    {% if path_snapping %}
    'enablePathSnapping': {
        'SNAP_DISTANCE': {{ SNAP_DISTANCE }},
        'pathsLayer_url': "{% url core:path_layer %}"
    },
    {% endif %}
    'addObjectsLayer': {
        'getUrl': function(modelname) {
            return '{% url core:path_layer %}'.replace(new RegExp('path', 'g'), modelname);
        }
    },
    'init': {
        'enableDrawing': true,
        'objectBounds': {{ field|latlngbounds }},
        'pathsnapping': {{ path_snapping|yesno:"true,false" }},
        'layerStoreElemSelector': '#{{ attrs.id }}',
        'geojson': {{ field|geojsonfeature|safe }},  // If no field, will be null.
        'iconUrl': '{% static "mapentity/images/marker-trans.png" %}',
        'iconDragUrl': '{% static "mapentity/images/osrm_markers/marker-drag.png" %}',
        'shadowUrl': '{% static "leaflet/images/marker-shadow.png" %}'
    },
};
{% endblock settings %}

FormField.makeModule({{ module }}, {{ module }}_settings);

// Callback
{{ module }}Init = function (map, bounds) {
    {% smart_include "mapinit" %}
    
    var module = {{ module }};
    var fitToBounds = true;

    // We are displaying a form.
    // if no object instance, restore previous map view
    // Previous map view can come from list view, or from detail view
    if (!module.getObjectPk()) {
        if (MapEntity.Context.restoreLatestMapView(map, ['detail', 'list'])) {
            bounds = map.getBounds();
            // We just changed the map bounds, avoid resetting them...
            fitToBounds = false;
        }
    }
    module.init(map, bounds, fitToBounds);
};



</script>
