{% extends "mapentity/base.html" %}
{% load i18n leaflet_tags mapentity field_verbose_name land %}

{% block nav-list %}active{% endblock nav-list %}

{% block mainmap %}
    <div id="bboxfilter">
        {# ids: bbox_cities bbox_districts #}
        {% combobox_bbox_land %}
    </div>
    {% leaflet_map "mainmap" fitextent=False %}
{% endblock mainmap %}

{% block filters %}
    <form id="mainfilter" action="{{ datatables_ajax_url }}" class="well form-inline">
        {{ filterform.form.as_p }}
        <input id="reset" type="reset" class="btn" />
        <a id="filter" class="btn btn-primary"><i class="icon-search icon-white"></i> {% trans "Filter" %}</a>
    </form>
{% endblock filters %}

{% block mainlist %}
    <table id="objects-list" class="table table-striped table-bordered">
        <thead>
            <tr>
                {% for field in columns %}
                <th>{{ model|verbose:field }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div id="list-download-toolbar">
        <p>
            <i class="icon-download-alt"></i> 
            Exporter la liste
            <button class="btn btn-mini" name="csv" >CSV</button>
            <button class="btn btn-mini" name="shp" >ShapeFile</button>
            <button class="btn btn-mini" name="gpx" >GPX</button>
        </p>
    </div>

{% endblock mainlist %}

{% block extrabody %}
    {{ block.super }}

    <script type="text/javascript">
        
        // Trigger a call to the format url
        $('#list-download-toolbar button').on('click', function () {
            var format = $(this).attr('name');
            var url = "{{Â model.get_format_list_url }}" + '?' +
                      $('#mainfilter').serialize() + '&format=' + format;

            document.location = url;
            return false;
        });

        L.Control.Screenshot.prototype.options.title = "{% trans "Save map as image" %}";

        function mainmapInit(map, bounds) {
            {% smart_include "mapinit" %}
            
            map.removeControl(map.attributionControl);
            map.doubleClickZoom.disable();
            
            {% if DEBUG %}
            map.on('viewreset moveend', function () {
                if (!map._loaded)
                    return;
                var n = objectsLayer.search(map.getBounds()).length;
                objectsLayer.fire('info', {info : n + ' objects shown'});
            });
            map.addControl(new L.Control.Information());
            {% endif %}

            map.addControl(new L.Control.ResetView(bounds));
            map.addControl(new L.Control.Measurement());
            
            var getUrl = function (properties, layer) {
                //TODO use nice JS url rewriting
                return "{{ model.get_generic_detail_url }}".replace('0', properties.pk);
            };
            
            var objectsLayer = new L.ObjectsLayer(null, {
                objectUrl: getUrl,
                style: {opacity: 1.0, fillOpacity:0.7, color: '{{ LAYERCOLOR_OTHERS }}'}
            });
            map.addLayer(objectsLayer);
            map.layerscontrol.addOverlay(objectsLayer, '{{ objectsname|title }}');
            objectsLayer.load("{{ model.get_layer_url }}");

            var dt = JQDataTable.init($('#objects-list'), null /* no load at startup */, {
                // Hide pk column
                aoColumnDefs: [ { "bVisible": false, "aTargets": [ 0 ] } ],
                sDom: "<'row-fluid'<'span6'i><'span6'f>r>t<'row-fluid'<'span6'l><'span6'p>>",
                aaData: [],
                iDeferLoading: 0
            });            
            // Hardcore Datatables customizations
            $('li.next a').html($('li.next a').html().replace('Next', ''));
            $('li.prev a').html($('li.prev a').html().replace('Previous', ''));

            var mapsync = new L.MapListSync(dt,
                                            map, 
                                            objectsLayer, {
                                                filter: {
                                                    form: $('#mainfilter'),
                                                    submitbutton: $('#filter'),
                                                    resetbutton: $('#reset'),
                                                    bboxfield: $('#id_bbox'),
                                                }
                                            });
            
            mapsync.on('reloaded', function (data) {
                // Show and save number of results
                MapEntity.showNumberSearchResults(data.nbrecords);
            });
            
            var screenshot = new L.Control.Screenshot()
            screenshot.on('trigger', function () {
                var fullContext = MapEntity.Context.serializeFullContext(map, '#mainfilter', dt);
                // Hack to download response attachment in Ajax
                $('<form action="{% url mapentity:map_screenshot %}" method="post">' + 
                '<textarea name="printcontext">' + fullContext + '</textarea>' + 
                '</form>').appendTo('body').submit().remove();
            });
            map.addControl(screenshot);
            
            MapEntity.Context.restoreFullContext(map, '#mainfilter', dt, '{{ objectsname|title }}');
            $(window).unload(function () {
                MapEntity.Context.saveFullContext(map, '#mainfilter', dt);
            });
        }
    </script>

{% endblock extrabody %}
