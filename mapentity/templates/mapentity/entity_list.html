{% extends "mapentity/base.html" %}
{% load i18n leaflet_tags field_verbose_name land %}

{% block nav-list %}active{% endblock nav-list %}

{% block mainmap %}
    <div id="bboxfilter">
        {# ids: bbox_cities bbox_districts #}
        {% combobox_bbox_land %}
    </div>
    {% leaflet_map "mainmap" fitextent=False %}
{% endblock mainmap %}

{% block filters %}
    <form id="mainfilter" action="{{ datatables_ajax_url }}" class="well form-inline">
        {{ filterform.form.as_p }}
        <input id="reset" type="reset" class="btn" />
        <a id="filter" class="btn btn-primary"><i class="icon-search icon-white"></i> {% trans "Filter" %}</a>
    </form>
{% endblock filters %}

{% block mainlist %}
    <table id="objects-list" class="table table-striped table-bordered">
        <thead>
            <tr>
                {% for field in columns %}
                <th>{{ model|verbose:field }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div id="list-download-toolbar">
        <p>
            <i class="icon-download-alt"></i> 
            Exporter la liste
            <button class="btn btn-mini" name="csv" >CSV</button>
            <button class="btn btn-mini" name="shp" >ShapeFile</button>
            <button class="btn btn-mini" name="gpx" >GPX</button>
        </p>
    </div>

{% endblock mainlist %}

{% block extrabody %}
    {{ block.super }}

    <script type="text/javascript">
        
        // Trigger a call to the format url
        $('#list-download-toolbar button').on('click', function () {
            var format = $(this).attr('name');
            var url = "{{Â model.get_format_list_url }}" + '?' +
                      $('#mainfilter').serialize() + '&format=' + format;

            document.location = url;
            return false;
        });

        L.Control.Screenshot.prototype.options.title = "{% trans "Save map as image" %}";

        function mainmapInit(mainmap, bounds) {
            mainmap.removeControl(mainmap.attributionControl);
            mainmap.doubleClickZoom.disable();
            
            {% if DEBUG %}
            mainmap.on('viewreset moveend', function () {
                if (!mainmap._loaded)
                    return;
                var n = objectsLayer.search(mainmap.getBounds()).length;
                objectsLayer.fire('info', {info : n + ' objects shown'});
            });
            mainmap.addControl(new L.Control.Information());
            {% endif %}

            mainmap.addControl(new L.Control.ResetView(bounds));
            mainmap.addControl(new L.Control.Measurement());
            
            // Always show the path layer, except if model is path
            // TODO: this is not supposed to be in mapentity --> caminae.common
            if ('{{ model.get_layer_url }}' != '{% url core:path_layer %}') {
                var paths = new L.ObjectsLayer(null, {
                    indexing: false,
                    style: { clickable:false, weight:2, color:'{{ LAYERCOLOR_PATHS }}'}
                });
                paths.addTo(mainmap)
                paths.load('{% url core:path_layer %}');
                mainmap.layerscontrol.addOverlay(paths, '{% trans "Paths" %}');
            }
            // Add land layers (TODO--> caminae.common)
            var landLayers = [{url:'{% url land:district_layer %}', name: '{% trans "District" %}'},
                              {url:'{% url land:city_layer %}', name: '{% trans "City" %}'},
                              {url:'{% url land:restrictedarea_layer %}', name: '{% trans "Restricted Area" %}'}];
            for (var i=0; i<landLayers.length; i++) {
                var landLayer = landLayers[i];
                var layer = new L.ObjectsLayer(null, {
                    indexing: false,
                    style: { clickable:false, weight:4, opacity: 0.3, fillOpacity: 0.0, color:'{{ LAYERCOLOR_LAND }}'}
                });
                layer.addTo(mainmap)
                layer.load(landLayer.url);
                mainmap.layerscontrol.addOverlay(layer, landLayer.name);
            }
            
            var getUrl = function (properties, layer) {
                //TODO use nice JS url rewriting
                return "{{ model.get_generic_detail_url }}".replace('0', properties.pk);
            };
            
            var objectsLayer = new L.ObjectsLayer(null, {
                objectUrl: getUrl,
                style: {opacity: 1.0, fillOpacity:0.7, color: '{{ LAYERCOLOR_OTHERS }}'}
            });
            mainmap.addLayer(objectsLayer);
            mainmap.layerscontrol.addOverlay(objectsLayer, '{{ objectsname|title }}');
            objectsLayer.load("{{ model.get_layer_url }}");

            var dt = JQDataTable.init($('#objects-list'), null /* no load at startup */, {
                // Hide pk column
                aoColumnDefs: [ { "bVisible": false, "aTargets": [ 0 ] } ],
                sDom: "<'row-fluid'<'span6'i><'span6'f>r>t<'row-fluid'<'span6'l><'span6'p>>",
                aaData: [],
                iDeferLoading: 0
            });            
            // Hardcore Datatables customizations
            $('li.next a').html($('li.next a').html().replace('Next', ''));
            $('li.prev a').html($('li.prev a').html().replace('Previous', ''));

            
            var mapsync = new MapEntity.MapListSync(dt,
                                                    mainmap, 
                                                    objectsLayer, {
                                                        filter: {
                                                            form: $('#mainfilter'),
                                                            submitbutton: $('#filter'),
                                                            resetbutton: $('#reset'),
                                                            bboxfield: $('#id_bbox'),
                                                        }
                                                    });
            
            mapsync.on('reloaded', function (data) {
                // Show and save number of results
                MapEntity.showNumberSearchResults(data.nbrecords);
            });
            
            $('#reset').click(function () {
                MapEntity.resetForm($(this));
            });
            
            var screenshot = new L.Control.Screenshot()
            screenshot.on('trigger', function () {
                var fullContext = MapEntity.Context.serializeFullContext(mainmap, '#mainfilter', dt);
                // Hack to download response attachment in Ajax
                $('<form action="{% url mapentity:map_screenshot %}" method="post">' + 
                '<textarea name="printcontext">' + fullContext + '</textarea>' + 
                '</form>').appendTo('body').submit().remove();
            });
            mainmap.addControl(screenshot);
            
            MapEntity.Context.restoreFullContext(mainmap, '#mainfilter', dt, '{{ objectsname|title }}');
            $(window).unload(function () {
                MapEntity.Context.saveFullContext(mainmap, '#mainfilter', dt);
            });
        }
    </script>

{% endblock extrabody %}
