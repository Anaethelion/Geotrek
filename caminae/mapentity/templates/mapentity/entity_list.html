{% extends "mapentity/base.html" %}
{% load i18n static leaflet_tags mapentity field_verbose_name %}

{% block nav-list %}active{% endblock nav-list %}

{% block container %}
    <div id="container">

    <!-- List Panel -->
    <div id="panelleft">

        <!-- Modules Panel -->
        <div id="entitylist">
            <ul class="nav nav-pills nav-stacked">
                <li class="centered {% block nav-path %}{% endblock nav-path %}"><a href="{% url core:path_list %}" title="{% trans "Path" %}"><img src="{% static "images/path.png" %}" style="width: 50px;"></img></a></li>
                <li class="centered {% block nav-intervention %}{% endblock nav-intervention %}"><a href="{% url maintenance:intervention_list %}" title="{% trans "Intervention" %}"><img src="{% static "images/intervention.png" %}"/></a></li>
                <li class="centered {% block nav-project %}{% endblock nav-project %}"><a href="{% url maintenance:project_list %}" title="{% trans "Project" %}"><img src="{% static "images/project.png" %}"/></a></li>
                <li class="centered {% block nav-signage %}{% endblock nav-signage %}"><a href="{% url infrastructure:signage_list %}" title="{% trans "Signage" %}"><img src="{% static "images/signage.png" %}"/></a></li>
                <li class="centered {% block nav-infrastructure %}{% endblock nav-infrastructure %}"><a href="{% url infrastructure:infrastructure_list %}" title="{% trans "Infrastructure" %}"><img src="{% static "images/infrastructure.png" %}"/></a></li>
                <li class="centered {% block nav-trekking %}{% endblock nav-trekking %}"><a href="{% url trekking:trek_list %}" title="{% trans "Trek" %}"><img src="{% static "images/trek.png" %}"/></a></li>
                <li class="centered {% block nav-poi %}{% endblock nav-poi %}"><a href="{% url trekking:poi_list %}" title="{% trans "POI" %}"><img src="{% static "images/poi.png" %}"/></a></li>
            </ul>
        </div>

        <div id="list-panel">
            
            <div class="btn-toolbar">
                {% block mainactions %}
                {% endblock mainactions %}
                
                {% smart_include "listactions" %}
                
                {% include "mapentity/entity_list_filter_fragment.html" %}
            </div>
            
            {% block mainlist %}
                <table id="objects-list" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            {% for field in columns %}
                            <th>{{ model|verbose:field }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>

                <div id="list-download-toolbar">
                    <div class="btn-group">
                        <button class="btn btn-mini" name="csv" title="{% trans "CSV" %}"><img src="{% static "paperclip/fileicons/csv.png" %}"></button>
                        <button class="btn btn-mini" name="shp" title="{% trans "Shapefile" %}"><img src="{% static "paperclip/fileicons/shp.png" %}"></button>
                        <button class="btn btn-mini" name="gpx" title="{% trans "GPX" %}"><img src="{% static "paperclip/fileicons/gpx.png" %}"></button>
                     </div>
                </div>
            {% endblock mainlist %}
        </div>
    </div>

    <!-- Map Panel -->
    <div id="panelright">
        <div class="map-panel">
        {% block mainmap %}
            <div id="maphead">
                {% smart_include "maphead" %}
            </div>
            <div id="mainmap"/>
        {% endblock mainmap %}
        </div>
    </div>
    
    </div>
{% endblock container %}


{% block extrabody %}
    {{ block.super }}

    {% leaflet_map "mainmap" fitextent=False creatediv=False %}

    <script type="text/javascript">
        function adjustDisplayLength(dTable) {
            var nTable = $(dTable.fnSettings().nTable),
                wrapper = nTable.parents('.dataTables_wrapper').first(),
                extraHead = 30 + nTable.position().top - wrapper.position().top,
                rowHeight = nTable.find('tbody tr').height();
            
            var displayLength = Math.floor((wrapper.height() - extraHead) / rowHeight);
            dTable.fnSettings()._iDisplayLength = Math.max(1, displayLength -1); //<thead>
            dTable.fnDraw(false);
        };

        $(document).ready(function() {
            // Show tooltips on left menu
            $('#entitylist a').tooltip({'placement': 'right'});

            // Trigger a call to the format url
            $('#list-download-toolbar button').on('click', function () {
                var format = $(this).attr('name');
                var url = "{{Â model.get_format_list_url }}" + '?' +
                          $('#mainfilter').serialize() + '&format=' + format;

                document.location = url;
                return false;
            });

            L.Control.Screenshot.prototype.options.title = "{% trans "Save map as image" %}";
        });

        function mainmapInit(map, bounds) {
            {% smart_include "mapinit" %}

            map.removeControl(map.attributionControl);
            map.doubleClickZoom.disable();

            map.addControl(new L.Control.Information());
            map.addControl(new L.Control.ResetView(bounds));
            map.addControl(new L.Control.Measurement());


            /*
             * Objects Layer
             * .......................
             */
            var getUrl = function (properties, layer) {
                //TODO use nice JS url rewriting
                return "{{ model.get_generic_detail_url }}".replace('0', properties.pk);
            };
            
            var objectsLayer = new L.ObjectsLayer(null, {
                objectUrl: getUrl,
                style: {opacity: 0.9, fillOpacity:0.7, color: window.SETTINGS.map.colors.others},
                onEachFeature: function (geojson, layer) {
                    if (geojson.properties.name) layer.bindLabel(geojson.properties.name);
                }
            });
            objectsLayer.on('highlight select', function (e) {
                if (e.layer._map !== null) e.layer.bringToFront();
            });
            map.addLayer(objectsLayer);

            // 
            map.on('layeradd', function () {
                objectsLayer.bringToFront();
            });
            objectsLayer.load("{{ model.get_layer_url }}", true);


            /*
             * Datatables
             * .......................
             */
            var dt = JQDataTable.init($('#objects-list'), null /* no load at startup */, {
                // Hide pk column
                aoColumnDefs: [ { "bVisible": false, "aTargets": [ 0 ] } ],
                sDom: "tpf",
                aaData: [],
                iDeferLoading: 0,
                iDisplayLength: 15,  // TODO: this is VERY ANNOYING ! I want to fill height !
            });
            // Adjust vertically
            adjustDisplayLength(dt);
            $(window).resize(function (e) {
                adjustDisplayLength(dt);
            });
            
            // Hardcore Datatables customizations
            $('li.next a').html($('li.next a').html().replace('Next', ''));
            $('li.prev a').html($('li.prev a').html().replace('Previous', ''));
            $('#objects-list_filter input').attr('placeHolder', "{% trans "Search" %}");
            $('#objects-list_filter label').contents().filter(function() {return this.nodeType === 3;/*Node.TEXT_NODE*/}).remove();


            /*
             * Assemble components
             * .......................
             */
            var mapsync = new L.MapListSync(dt,
                                            map, 
                                            objectsLayer, {
                                                filter: {
                                                    form: $('#mainfilter'),
                                                    submitbutton: $('#filter'),
                                                    resetbutton: $('#reset'),
                                                    bboxfield: $('#id_bbox'),
                                                }
                                            });
            
            mapsync.on('reloaded', function (data) {
                // Show and save number of results
                MapEntity.history.saveListInfo({model:'{{ modelname }}', 
                                                nb: data.nbrecords});
                // Show layer info
                objectsLayer.fire('info', {info : (data.nbrecords + ' ' + '{% trans "results" %}')});
            });

            // Main filter
            var t = new MapEntity.TogglableFilter();
            mapsync.on('reloaded', function (data) {
                t.setsubmit();
            });

            // Map screenshot button
            var screenshot = new L.Control.Screenshot('{% url mapentity:map_screenshot %}', function () {
                return MapEntity.Context.serializeFullContext(map, '#mainfilter', dt);
            });
            map.addControl(screenshot);

            // We can have several contexts in the application (mainly 'detail' and 'list')
            // Using prefixes is a way to manage this.
            MapEntity.Context.restoreFullContext(map,
                getURLParameter('context'),
                {
                    filter: '#mainfilter',
                    datatable: dt,
                    objectsname: '{{ objectsname|title }}',
                    prefix: 'list',
                }
            );
            $(window).unload(function () {
                MapEntity.Context.saveFullContext(map, {
                    filter: '#mainfilter',
                    datatable: dt,
                    prefix: 'list',
                });
            });
        }
    </script>

{% endblock extrabody %}
