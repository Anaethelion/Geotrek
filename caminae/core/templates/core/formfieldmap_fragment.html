{% load maps leaflet_tags geojson_tags static %}

{% leaflet_map module fitextent=False %}
<style type="text/css">
    {% if not display_wkt %}#{{ attrs.id }} { display: none; }{% endif %}
</style>

<link rel="stylesheet" href="{% static "Leaflet.draw/leaflet.draw.css" %}"></link>
<script type="text/javascript" src="{% static "Leaflet.draw/leaflet.draw.js" %}"></script>


{% if display_wkt %}<p> WKT debugging window:</p>{% endif %}
{% include "floppyforms/textarea.html" %}

<script type="text/javascript">
function {{ module }}EnableDrawing(map, drawncallback, startovercallback) {
    var drawControl = new L.Control.Draw({
        position: 'topright',
        polygon: {{ is_polygone|yesno:"true,false" }},
        rectangle: false,
        circle: false,
        marker: {{ is_point|yesno:"true,false" }},
        polyline: {{ is_linestring|yesno:"true,false" }} && {
            shapeOptions: {
                color: '#35FF00',
                opacity: 0.8,
                weight: 3
            }
        }
    });
    map.addControl(drawControl);
    map.drawControl = drawControl;

    // Delete current on first clic (start drawing)
    map.on('click', function (e) {
        // Delete current on clic if drawing
        for (var handlertype in map.drawControl.handlers) {
            if (map.drawControl.handlers[handlertype].enabled()) {
                startovercallback();
                return;
            }
        }
    });

    // Listen to all events of creation
    var draw_types = {
        'polyline': 'poly',
        'point': 'marker',
        'polygon': 'polygon',
    };
    for (var geomtype in draw_types) {
        var draw_type = draw_types[geomtype];
        map.on('draw:' + draw_type + '-created', L.Util.bind(function (e) {
            console.log('Drawn ' + this.type);
            var new_layer = e[this.type];
            drawncallback(new_layer);
        }, {type: draw_type}));
    }
};


function {{ module }}EnablePathSnapping(map, snappedLayer, guidesLayer) {
    if (!guidesLayer) {
        // If not provided, add a new path layer
        guidesLayer =  new Caminae.ObjectsLayer(null, {
            style: {weight: 2, clickable: false},
        });
        map.addLayer(guidesLayer);
        guidesLayer.load("{% url core:path_layer %}");
    }

    var refreshSnapList = function () {
        if (map.getZoom() > 12) {
            var guides = guidesLayer.search(map.getBounds());
            snappedLayer.eachLayer(function (l) {
                l.editing.setSnapList(guides);
            });
        }
    };

    guidesLayer.on('load', function() {
        refreshSnapList()
        map.on('viewreset moveend', refreshSnapList);
    });
};

function {{ module }}AddObjectsLayer(map, modelname) {
    // On creation, this should be null
    var object_pk = $('form input[name="pk"]').val() || null;

    var exclude_current_object = null;
    if (object_pk) {
        exclude_current_object = function (geojson) {
            if (geojson.properties && geojson.properties.pk)
                return geojson.properties.pk != object_pk;
        }
    }

    // Start loading all objects, readonly
    // Build URL like an animal, please don't tell my mother.
    var objectsLayer = new Caminae.ObjectsLayer(null, {
            style: {weight: 2, clickable: false},
            filter: exclude_current_object
        }),
        url = '{% url core:path_layer %}'.replace('path', modelname); 
    map.addLayer(objectsLayer);
    objectsLayer.load(url);
    return objectsLayer;
};

function {{ module }}Init(map, bounds) {
    map.removeControl(map.attributionControl);
    
    /*** <Map bounds and reset> ***/
    
    var initialBounds = bounds,
         objectBounds = {{ field|latlngbounds }},
         currentBounds = objectBounds || initialBounds;
    getBounds = function () {
        return currentBounds;
    };
    map.addControl(new L.Control.ResetView(getBounds));
    map.fitBounds(currentBounds);
    map.addControl(new L.Control.Scale());

    // Show other objects of same type
    var modelname = $('form input[name="model"]').val(),
        objectsLayer = {{ module }}AddObjectsLayer(map, modelname);
    
    /*** <objectLayer> ***/

    var geojson = {{ field|geojsonfeature|safe }};  // If no field, will be null.
    var objectLayer = new L.GeoJSON(geojson, {
        style: {weight: 5, opacity: 1, clickable: false},
        onEachFeature: function (feature, layer) {
            onNewLayer(layer);
        }
    });
    map.addLayer(objectLayer);
    
    var layerStore = Caminae.makeGeoFieldProxy($('#{{ attrs.id }}'));
    
    // Enable snapping ?
    var path_snapping = {{ path_snapping|yesno:"true,false" }},
         edit_handler = L.Handler.PolyEdit;

    if (path_snapping) {
        var guidesLayers = (modelname == 'path') ? objectsLayers : null;
        {{ module }}EnablePathSnapping(map, objectLayer, guidesLayers);
        edit_handler = L.Handler.SnappedEdit;
    }

    function onNewLayer(new_layer) {
        var update_wkt = function (e) {
            layerStore.storeLayerGeomInField(e.target);
        };
        if (new_layer instanceof L.Marker) {
            currentBounds = map.getBounds(); // take current bounds
            edit_handler = Caminae.MarkerSnapping;
            // TODO: New markers should be draggable !
            //new_layer.dragging = new L.Handler.MarkerDrag(new_layer);
            //new_layer.dragging.enable();
        }
        else {
            currentBounds = new_layer.getBounds();
        }
        new_layer.editing = new edit_handler(new_layer);
        new_layer.editing.enable();
        new_layer.on('edit', update_wkt);
        layerStore.storeLayerGeomInField(new_layer);
    }

    /*** </objectLayer> ***/

    /*** <drawing> ***/

    {{ module }}EnableDrawing(map,
        function (drawn_layer) {
            objectLayer.addLayer(drawn_layer);
            onNewLayer(drawn_layer);
        },
        function () {
            var old_layer = layerStore.getLayer();
            if (old_layer) {
                map.removeLayer(old_layer);
                currentBounds = initialBounds;
                layerStore.storeLayerGeomInField(null);
            }
        }
    );
}
</script>
