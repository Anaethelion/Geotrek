{% extends "core/base.html" %}
{% load i18n leaflet_tags %}

{% block mainmap %}
    {% leaflet_map "mainmap" %}
{% endblock mainmap %}


{% block mainactions %}
    {% if user.profile.is_path_manager %}
    <a class="btn" href="{{ path.get_add_url }}"><i class="icon-plus"></i> {% trans "Add a path" %}</a>
    {% else %}
    <a class="btn disabled" href="#"><i class="icon-plus"></i> {% trans "Add a path" %}</a>
    {% endif %}
{% endblock mainactions %}


{% block mainlist %}
    <!-- Liste des rÃ©sultats automatiquement remplis par dataTables -->
    <h1>{% trans "Filter" %}</h1>

    <form id="mainfilter" action="{{ datatables_ajax_url }}">
        {{ filterform.form.as_p }}
        <input id="reset" type="reset" class="btn" />
        <a id="filter" class="btn btn-primary"><i class="icon-search icon-white"></i> {% trans "Filter" %}</a>
    </form>

    <table id="path-ajax-list" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>{% trans "Name" %}</th>
                <th>{% trans "Modified" %}</th>
                <th>{% trans "Length" %}</th>
                <th>{% trans "Trail" %}</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
{% endblock mainlist %}


{% block extrabody %}
    {{ block.super }}

    <h1>Listes temporaires (recette stories #10, 15, #31)</h1>

    <h2>{% trans "Usages" %}</h2>
    {% for usage in all_usages %}
        <li>{{ usage }}</li>
    {% empty %}
        {% trans "Empty" %}
    {% endfor %}

    <h2>{% trans "Contractors" %}</h2>
    {% for contractor in all_contractors %}
        <li>{{ contractor }}</li>
    {% empty %}
        {% trans "Empty" %}
    {% endfor %}

    <h2>{% trans "Structure related" %}</h2>
    {% for contractor in contractors %}
        <li>{{ contractor }}</li>
    {% empty %}
        {% trans "Empty" %}
    {% endfor %}

    <script type="text/javascript">
        function mainmapInit(mainmap) {
            var objectsLayer = new Caminae.ObjectsLayer(null, {
                onEachFeature: function (feature, layer) {
                    layer.on('click', function (e) {
                        //TODO use nice JS url rewriting
                        window.location = "{% url core:path_detail 0 %}".replace('0', feature.properties.pk);
                    });
                }
            });
            mainmap.addLayer(objectsLayer);
            objectsLayer.load("{% url core:layer_path %}");

            // init ajax list
            initAjaxList(objectsLayer);
        }
    </script>


{% include "dataTables_template.html" %}
<script>
    /* Table initialisation */
    function initAjaxList(objectsLayer) {

        var filterform = $('#mainfilter')
          , submitbutton = $('#filter')
          , ajax_list = $('#path-ajax-list')
        ;

        // on JSON load, return the json used by dataTable
        // Update also the map given the layer's pk
        var extract_data_and_pks = function(data, type) {
            objectsLayer.updateFromPks(data.map_path_pk)
            return data.aaData;
        }

        // initialize data table
        var dt = JQDataTable.init(
              ajax_list
            , filterform.attr('action')
            , { "sAjaxDataProp": extract_data_and_pks }
        });

        // On submit, trigger an ajax request to the JSON view
        // Update the ajax list and the map
        submitbutton.click(function() {
            var url = filterform.attr("action") + '?' + filterform.serialize()
            dt.fnReloadAjax(url);

            return false;
        });
    };
</script>

{% endblock extrabody %}
